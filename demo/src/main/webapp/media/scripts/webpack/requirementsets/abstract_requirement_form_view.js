'use strict';

import Backbone from 'backbone';
import $ from 'jquery';
import ButtonTemplate from './templates/button.hbs';
import SelectTemplate from './templates/select.hbs';
import MandatoryTemplate from './templates/mandatory.hbs';
import AbstractRequirementTemplate from './templates/abstract-requirement-form.hbs';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                export default Backbone.View.extend({
	buttonTemplate: ButtonTemplate,
	selectTemplate: SelectTemplate,
	mandatoryTemplate: MandatoryTemplate,
	template: AbstractRequirementTemplate,

	events: {
		'click [data-action="add"]'                    : 'add',
		'change select[data-selections="requirables"]' : 'resetForm'
	},

	initialize: function (options) {
		this.formType = options.formType;
		this.formLabel = options.formLabel;
		this.requirementSet = options.requirementSet;
		this.requirementTypes = options.requirementTypes;
		this.disableRequirables();
		this.render();
	},

	render: function () {
		throw 'RenderNotImplementedException';
	},

	add: function (e) {
		e.preventDefault();
		$(e.currentTarget).prop('disabled', true);
		var requirement = this.requirementSet.get('requirements').add(this.getRequirement());
		Backbone.Events.trigger('Requirement:added', requirement);
	},

	resetForm: function (e) {
		e.preventDefault();
		$(e.currentTarget).find('option.prompt').remove();
		this.$('[data-action="add"]').prop('disabled', false);
	},

	disableRequirables: function () {
		if (!this.collection) {
			return;
		}
		this.collection.each(function (item) {
			item.disabled = false
		});

		this.requirementSet.get('requirements').each(function (item) {
			if (item.get('requirable')) {
				var requirable = this.collection.findWhere({
					id: item.get('requirable').id,
					name: item.get('requirable').name
				});

				if (requirable) {
					requirable.disabled = true
				}
			}
		}, this);
	},

	getRequirement: function () {
		var requirableId = parseInt(this.$('[data-selections="requirables"]').val(), 10);

		if (isNaN(requirableId)) {
			requirableId = this.$('[data-selections="requirables"]').val();
		}

		var mandatory = this.$('[data-placeholder="mandatory"] input').prop('checked');
		var requirable = this.collection && this.collection.findWhere({ id: requirableId });
		//check this
		var requirementType = this.requirementTypes.findWhere({ name: this.formType });
		var name = (requirable && requirable.get('name')) || requirementType.get('defaultRequirableName');
		if (this.partitionName) { name = this.partitionName + ' - ' + name; }

		return {
			$type: this.formType,
			requirable: {
				name:  name,
				id: requirableId
			},
			mandatory: mandatory,
			notifyOnExpiry: false,
			removeMembershipOnExpiry: false
		};
	}
});
